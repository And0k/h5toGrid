## [incl_load](incl_load.py) в пакете программ [h5toGrid](../.)
Программа позволяет рассчитывать скорости течений по данным инклинометров, усреднять и записывать результат в текстовые данные по гигабайтным файлам исходных данных.
Описание установки пакета - [readme[RU].md](../readme[RU].md) в директории выше

### Конфигурация

- задается файлом с расширением _yml_ в формате [YAML](http://yaml.org/spec/1.2/spec.html)
Описание параметров, которые также могут задаваться как параметры командной строки, можно получить командой:
```cmd
python -m incl_load --help
```
Суффиксы типа данных в параметрах файла yml отбрасываются.

#### Параметры
Возможно, что единственным параметром, который вам потребуется менять будет расположение исходных данных. Учтите, что они (или архив, или папка с ними) должны находится в каталоге "\*inclinometer\*\\_raw". .

- Секция "`in`"
  - `path_cruise` - существующий каталог, который должен или 1. содержать слово "inclinometer" и папку "\_raw" или 2. не содержать слово "inclinometer" и иметь подпапку "\inclinometer\_raw". В папке "\_raw" должны быть исходные данные, или подпапка, или архив с ними. В двух последних случаях он указывается в `raw_subdir`. В родительскую папку "_raw" будут записываться результаты выполнения, если параметр `out`.`db_name` (см ниже) содержит не полный путь, а лишь имя выходного hdf5 файла.
  - `raw_subdir` - подкаталог или архив zip/rar в папке "\_raw" где содержаться исходные данные. Eсли исходные файлы не в архиве или подпапке от "\_raw", то ничего не указывать или закомментировать в yml.
  - `probes` - список номеров датчиков для обработки, если пуст - будет поиск и обработка всех из диапазона 1-40
  - `probes_prefix` - incl_b - приставка в именах таблиц hdf5 фалов, включая файл коэффициентов. Для для данного типа инклинометров менять не следует.
  - `raw_pattern` -  "\*\{prefix:}{number:0>2}\*\.\[tT]\[xX]\[tT]" - маска имен исходных файлов. Для данного типа инклинометров менять не следует. Поскольку "prefix" это `probes_prefix`, но в верхнем регистре, и где _INCL_ заменено на _INKL_, то маска имен исходных файлов получается "INKL_B`№`\*\.\[tT]\[xX]\[tT]". Здесь и далее `№` - числовой номер инклинометра дополненный нулем слева, если длина числа < 2.
  - `db_coefs` - путь к hdf5 файлу коэффициентов
- Секция "`filter`"
  - `date_min`, `date_max`: {`цифровой номер инклинометра`: `дата`, ...} - временные границы загрузки данных для каждого инклинометра. Номер 0 - соответствует границам по умолчанию. Дата должна быть в формате [ISO 8601](https://ru.wikipedia.org/wiki/ISO_8601).
- Секция "`out`"
  - `db_name` - имя выходного hdf5 файла 1го этапа работы программы (см [ниже](#Программа-работает-в-два-этапа))
  - `aggregate_period_s` - список, содержащий интервалы усреднений: для каждой величины будут записаны текстовые файлы с соответствующим суффиксом. Null в файле YAML означает "без усреднения". При расчете усредненных значений используется ранее записанный hdf5 файл, рассчитанный без усреднений.
- Секция "`program`" - здесь задаются этапы работы программы (см ниже).
  - `step_start` - первый шаг. Можно менять если имеются результаты предыдущего этапа
  - `step_end` -  послений шаг
 

### Запуск

Загрузить окружение _py3.7x64h5togrid_ командой:
```cmd
conda activate py3.7x64h5togrid
```
Перейти в каталог программы обработки инклинометров (замените на свой - куда вы скачали пакет):
```cmd
cd d:\Work\_Python3\And0K\h5toGrid\inclinometer
```
Запустить программу:
```cmd
python -m incl_load tests/data/inclinometer/200813incl_load#b-sent.yml
```

При запуске последней команды используются файлы:
- [tests/data/inclinometer/200813incl_load#b-sent.yml](./tests/data/inclinometer/200813incl_load%23b-sent.yml) - конфигурационный файл
- [tests/data/inclinometer/incl#b.h5](./tests/data/inclinometer/incl%23b.h5) - файл коэффициентов
- [tests/data/inclinometer/_raw/mag_components_calibration.zip](./tests/data/inclinometer/_raw/mag_components_calibration.zip) - пример данных

### Результат работы

#### Программа работает в два этапа:

1. Конвертация (интервала) данных в [формат hdf5](https://ru.wikipedia.org/wiki/Hierarchical_Data_Format) с автоматической коррекцией времени: улучшение разрешения по сравнению с исходными 1с с указанной частотой для создания возрастающей последовательности (от которой можно строить графики с максимальным разрешением - актуально для малых интервалов, а также работы некоторых алгоритмов обработки).
Сначала, на этом этапе в папке "\_raw" (в подпапке если указывался `raw_subdir`) создаются промежуточные файлы incl_b*.txt - это исходные файлы в которых удалены нерегулярные строки или строки очищены от лишних символов. Если такой файл уже присутствует для нужного номера инклинометра, то он не пересоздается. Далее, идет его конвертация в hdf5.

2. Чтение данных предыдущего этапа и расчет и усреднение физических параметров.
**В результате создаются файлы**:
- Текстовые *.tsv (ASCII, разделитель - табуляция) - в папке "text_output" текущего каталога, разбитые по дням, названные по времени и номеру инклинометра. Названия файлов имеют вид "191108_1200_i07.tsv", где:
  - 191108_1200 - время начала данных в файле, ггммдд_ЧЧММ,
  - i - тип прибора: i - инклинометр, w - волнограф,
  - 07 - номер прибора.
  
  Если файлы в названии имеют дополнительно строку "bin600s", значит данные усреднены в ячейках по 10мин. Данные инклинометров с исходной частотой данных разбиваются посуточно. 

  Файлы данных инклинометров содержат следующие колонки данных:
  - Time - Калининградское время, гггг-мм-дд ЧЧ:ММ:СС.СССССС,
  - Vabs - модуль скорости течения, м/c,
  - Vdir - направление скорости течения, м/с,
  - Vn - северная составляющая проекции скорости течения, м/с,
  - Ve - восточная составляющая проекции скорости течения, м/с,
  - inclination - угол наклона инклинометра, °,
  - Temp - температура по датчику температуры микросхемы часов реального времени (используется для термокомпенсации т.е. получения более стабильных отсчетов времени), °C.

- В формате hdf5 (формат используются при расчетах и может читаться программой визуализации [Veusz](https://veusz.github.io/download/)):
  - *_proc_noAvg.h5 - данные скорости течений, без усреднения, отдельная таблица для каждого инклинометра
  - *_proc.h5 - данные скорости течений с усреднением, в отдельную таблицу для каждого значения усреднения помещены данные всех инклинометров по колонкам. Файл *_proc.h5 создается на уровень выше текущего каталога. Таблицы данных (/V_incl_bin`усреднение в с`) содержат колонки:
    - index: время в формате [numpy.datetime64\[ns\]](https://numpy.org/doc/stable/reference/arrays.datetime.html#datetime-units)
    - Vn_i`№`, Ve_i`№`, Temp_i`№`, ...: 3 параметра одного инклинометра - те же что в описании результирующих текстовых файлов, после - идут эти же параметры для следующих инклинометров по порядку их номеров.
- *_not_sorted.h5 - вспомогательные, при нормальном завершении программы автоматически удаляются (не нужны после работы программы)

  ---
  Данные hdf5 можно редактировать программой [HDFView](https://www.hdfgroup.org/downloads/hdfview/), распространяемой в свободном доступе организацией HDF Group. Для просмотра таблиц где время отображается не в наносекундах от 1970-01-01, a в пользовательском формате, я использую [Vitables](http://vitables.org) установленную с помощью [miniconda](https://conda.io/miniconda.html) в отдельном окружении.

### Замеченные недостатки

лишние сообщения, например:
```
Ok. Ini file "D:\Work\_Python3\And0K\h5toGrid\inclinometer\incl_h5clc_out_send.yaml" dir not found, continue...
```

---
## Другие инструменты

### старая версия incl_load() не использующая конфигураций - скрипт 190711incl_load.py
содержит шаги:
1. _csv2h5_ - Конвертация (интервала) данных в формат hdf5 с автоматической коррекцией времени: улучшение разрешения по сравнению с исходными 1с с указанной частотой для создания возрастающей последовательности (от которой можно строить графики с максимальным разрешением - актуально для малых интервалов, а также работы некоторых алгоритмов обработки).
    - 1а. h5copy_coef - копирование коэффициентов в созданный hdf по пути данных соответствующего прибора
2. _veuszPropagate_ - построение по заданному шаблону
 
### Калибровка инклинометров - 190901incl_calibr.py
_incl_calibr_: По данным калибровки на стенде:
1. Мягкое железо
Полученные коэффициенты применяем к данным в бассейне для дальнейшей корректировки коэффициентов.

_h5from_veusz_coef_: Обработка данных из бассейна:
2. Калибровка нуля модуля скорости (вертикаль)
3. Калибровка нуля направления скорости (север, твердое железо)

### Построение множества однотипных графиков (в т.ч. долго отображаемых компьютером)
1. Настройка шаблона Veusz (построение). Для ускорения:
	- строить маленькую часть/прореженную часть
    - удалить расчеты: заменить формулы расчета нужных данных для отображения их результатом (меню "unlink"), остальные - удалить. После этого лучше сохранить в vszh5, затем настроить графики.
2. Удалить все данные и сохранить (графики) в ~no_data~.vsz.
3. В текстовом режиме заменить все графики из большого файла на графики из ~no_data~.vsz. Сохранить результат как шаблон для программы построения.
4. Запустить программу построения остальных частей по шаблону
